void 0===window.gettext&&(window.gettext=function(text){return text}),function(){var Agora=this.Agora={},app=this.app={};Agora.TopView=Backbone.View.extend({el:"#top-bar",events:{},initialize:function(){_.bindAll(this)}}),Agora.MainView=Backbone.View.extend({el:"body",events:{"click a.action-form-link":"onActionFormLinkClicked"},initialize:function(){_.bindAll(this),$(document).ajaxStop(this.updateUi),this.updateUi(),this.setMomentLang(),this.topBar=new Agora.TopView},updateUi:function(){},setMomentLang:function(){moment.lang(this.$el.data("lang"))},onActionFormLinkClicked:function(event){event.preventDefault();var target=$(event.currentTarget);this.$("#post-action-form").attr("action",target.attr("href")),this.$("#post-action-form").submit()}}),app.main=new Agora.MainView,Agora.MessagesBox=Backbone.View.extend({el:"#messages-box",initialize:function(){var modal=this.$(".modal");modal.length>0&&this.$(".modal").modal("show")}}),app.messages=new Agora.MessagesBox}.call(this);var Ajax=Backbone.View.extend({initialize:function(){_.bindAll(this)},setContext:function(ctx){this.ctx=ctx},get:function(url,data,type){return this.request("GET",url,data,type)},post:function(url,data,type){return this.request("POST",url,data,type)},put:function(url,data,type){return this.request("PUT",url,data,type)},"delete":function(url,data,type){return this.request("DELETE",url,data,type)},request:function(type,url,data,dataType){var ajax_data={url:url,dataType:dataType||"text",type:type};return void 0!==data&&(ajax_data.data=data),this.options.contentType&&(ajax_data.contentType=this.options.contentType),this.options.headers&&(ajax_data.headers=this.options.headers),ajax_data.complete=this.requestComplete,$.ajax(ajax_data)},requestComplete:function(jxhr,stat){this.trigger("success",jxhr,stat,this.ctx)}});(function(){var Agora=this.Agora;this.app,function(){var ElectionModel=Backbone.Model.extend({}),ElectionsCollection=Backbone.Collection.extend({model:ElectionModel});Agora.CalendarWidgetView=Backbone.View.extend({el:"#agora-calendar",events:{"keyup .election-search-query":"onSearchChange"},initialize:function(){_.bindAll(this),this.template=_.template($("#template-election").html()),this.collection=new ElectionsCollection,this.collection.on("reset",this.resetCollection);var ajax=new Ajax;ajax.on("success",this.initializeSuccess),ajax.get(this.$el.data("url")),this.onSearchChange=_.debounce(this.onSearchChange,400)},initializeSuccess:function(xhr){if(200===xhr.status){var data=JSON.parse(xhr.responseText);this.collection.reset(data.objects)}},onSearchChange:function(event){var target=$(event.currentTarget),data={q:target.val()},ajax=new Ajax;ajax.on("success",this.initializeSuccess),ajax.get(this.$el.data("url"),data),console.log("onSearchChange: "+target.val())},resetCollection:function(collection){this.$(".list-container").empty();var data=collection.groupBy(function(item){var date=item.get("voting_extended_until_date")||item.get("voting_ends_at_date")||item.get("voting_starts_at_date");return date?date.split("T")[0]:null});_.each(_.pairs(data),function(item){var key=item[0],val=item[1],date=moment(key),dom=this.template({datetime:date.format("LL"),items:val});this.$(".list-container").append(dom)},this),0===collection.length&&this.$(".list-container").append(this.$("#no-elections"))}})}.call(this),function(){var AgoraModel=Backbone.Model.extend({}),AgorasCollection=Backbone.Collection.extend({model:AgoraModel});Agora.AgoraWidgetListView=Backbone.View.extend({el:"#agora-list",initialize:function(){_.bindAll(this),this.agoraTemplate=_.template($("#template-agora").html()),this.agorasCollection=new AgorasCollection,this.agorasCollection.on("reset",this.resetAgorasCollection);var ajax=new Ajax;ajax.on("success",this.initializeSuccess),ajax.get(this.$el.data("url"))},initializeSuccess:function(xhr){if(200===xhr.status){var data=JSON.parse(xhr.responseText);this.agorasCollection.reset(data.objects)}},resetAgorasCollection:function(collection){if(this.$(".last-agoras .list-container").empty(),0===collection.length){var emptyItem=this.make("ul",{id:"no-agoras"},gettext("No agoras found"));this.$(".last-agoras .list-container").append(emptyItem)}else collection.each(this.addAgoraItem)},addAgoraItem:function(model){var dom=this.agoraTemplate(model.toJSON());this.$(".last-agoras .list-container").append(dom)}})}.call(this),function(){var ItemModel=Backbone.Model.extend({}),ItemCollection=Backbone.Collection.extend({model:ItemModel});Agora.GenericListView=Backbone.View.extend({el:"#activity-list",events:{"click a.endless_more":"onMoreClicked"},setup:function(){this.url=this.$el.data("url"),this.method=this.$el.data("method")||"get"},setupTemplates:function(){void 0!==this.templateEl&&(this.template=_.template($(this.templateEl).html()))},initialize:function(){_.bindAll(this),this.firstLoadSuccess=!1,this.finished=!1,this.collection=new ItemCollection,this.collection.on("reset",this.collectionReset),this.collection.on("add",this.addItem),this.endlessDom=this.$(".endless-container"),this.endlessDom.find("div.endless_loading").hide(),this.offset=0,this.limit=20,this.setup(),this.setupTemplates(),this.requestObjects(),$(window).scroll(this.infiniteScroll)},requestObjects:function(){if(!this.finished){var ajax=new Ajax;ajax.on("success",this.requestSuccess);var params=_.extend({},{limit:this.limit,offset:this.offset},this.params||{});this.offset+=this.limit,"get"===this.method?ajax.get(this.url,params):"post"===this.method&&ajax.post(this.url,params)}},setEndlessFinishDom:function(){this.endlessDom.find("a.endless_more").replaceWith(gettext("<span>No more results</span>")),this.endlessDom.find("div.endless_loading").hide()},requestSuccess:function(xhr){if(200===xhr.status){var data=JSON.parse(xhr.responseText);if(this.endlessDom.find("div.endless_loading").hide(),0===data.objects.length)this.setEndlessFinishDom(),this.finished=!0;else{var doc=$(document),win=$(window);this.firstLoadSuccess?(this.$("a.endless_more").show(),_.each(data.objects,function(item){this.collection.add(item)},this)):(this.firstLoadSuccess=!0,this.collection.reset(data.objects)),this.endlessDom.appendTo(this.$el),data.objects.length<this.limit?(this.setEndlessFinishDom(),this.finished=!0):doc.height()==win.height()&&0==win.scrollTop()&&(this.$("a.endless_more").click(),this.$("a.endless_more").hide(),this.endlessDom.find("div.endless_loading").show())}}},collectionReset:function(collection){this.$el.empty(),collection.each(this.addItem)},renderItem:function(model){return void 0!==this.template?this.template(model.toJSON()):"<div>REIMPLEMENT THIS</div>"},addItem:function(model){var html=this.renderItem(model);this.$el.append(html)},infiniteScroll:function(){var doc=$(document),win=$(window),margin=this.$el.data("margin")||300;!this.finished&&margin>=doc.height()-win.height()-win.scrollTop()&&(this.$("a.endless_more").click(),this.$("a.endless_more").hide(),this.endlessDom.find("div.endless_loading").show())},onMoreClicked:function(event){event.preventDefault(),this.requestObjects()}}),Agora.ActivityListView=Agora.GenericListView.extend({el:"#activity-list",setup:function(){this.url=this.$el.data("url"),this.method=this.$el.data("method")||"get",this.templates={}},renderItem:function(model){var json=model.toJSON();return this.templates[json.type_name]||(this.templates[json.type_name]=_.template($("#template-action_"+json.type_name).html()||"<#template-action_"+json.type_name+" not found>")),this.templates[json.type_name](json)}})}.call(this)}).call(this),function(){var Agora=this.Agora;this.app,Agora.HomeActivtyList=Agora.ActivityListView.extend({collectionReset:function(collection){this.$el.empty(),collection.each(this.addItem),this.slideShowElement="#activity_items",this.DELAY_SPEED=4e3,this.xy=d3.geo.mercator(),this.geopath=d3.geo.path().projection(this.xy),this.states=d3.select("#home_worldmap_canvas").append("svg").append("g").attr("id","states"),this.currentSlide=0,this.slides=$("#activity-list > div"),this.interval=setInterval(this.nextSlide,this.DELAY_SPEED);var self=this;this.slides.each(function(){$(this).appendTo($(self.slideShowElement))}),d3.json("/static/js/world-countries.json",function(collection){self.xy.scale(320);var translate=self.xy.translate();translate[0]=160,translate[1]=110,self.xy.translate(translate),self.states.selectAll("path").data(collection.features).enter().append("path").attr("d",self.geopath),self.slides.each(function(){self.geolocateElement($(this))})})},nextSlide:function(){this.currentSlide>=this.slides.length-1?this.currentSlide=0:this.currentSlide++,$(this.slideShowElement+" > div").first().removeClass("activity-action-first");var newElement=$(this.slides[this.currentSlide]).clone().addClass("activity-action-first").hide();newElement.prependTo($(this.slideShowElement)),newElement.animate({height:"toggle",opacity:"toggle"},"slow"),$(this.slideShowElement+" > div").last().remove(),this.geolocateElement(newElement),null!=this.interval&&clearInterval(this.interval),this.interval=setInterval(this.nextSlide,this.DELAY_SPEED)},geolocateElement:function(element){var geodata=element.attr("geodata");if(geodata.length>0){geodata=geodata.substr(1,geodata.length-2),geodata=geodata.split(",");var pos=[parseFloat(geodata[1]),parseFloat(geodata[0])];this.geolocate(pos)}},geolocate:function(pos){function animateSecondStep(){d3.select(this).transition().duration(35e3).style("fill-opacity","0").each("end",function(){d3.select(this).remove()})}pos=this.xy(pos),d3.select("#home_worldmap_canvas svg").append("svg:circle").style("fill-opacity","0.1").style("fill","red").attr("r",10).attr("cx",pos[0]).attr("cy",pos[1]).transition().delay(0).duration(1e3).attr("r",1.5).style("fill-opacity","1").each("end",animateSecondStep)}}),Agora.HomeAnonymousView=Backbone.View.extend({el:"body",initialize:function(){_.bindAll(this),$("#activity-list").length>0&&(this.activityListView=new Agora.HomeActivtyList)}})}.call(this),function(){var Agora=this.Agora;this.app,Agora.HomeView=Backbone.View.extend({el:"div.home",initialize:function(){_.bindAll(this),this.calendarView=new Agora.CalendarWidgetView,this.agoralistView=new Agora.AgoraWidgetListView,this.activityListView=new Agora.ActivityListView}})}.call(this),function(){var Agora=this.Agora;this.app,Agora.AgoraView=Backbone.View.extend({el:"div.agora",initialize:function(){_.bindAll(this),this.calendarView=new Agora.CalendarWidgetView,$("#activity-list").length>0&&(this.activityListView=new Agora.ActivityListView)}})}.call(this),function(){var AgoraInfiniteView=Agora.GenericListView.extend({el:"#activity-list",templateEl:"#template-search-agora-item"});Agora.AgoraListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new AgoraInfiniteView}})}.call(this),function(){var Agora=this.Agora;this.app,Agora.ElectionView=Backbone.View.extend({el:"div.election",initialize:function(){_.bindAll(this),$("#activity-list").length>0&&(this.activityListView=new Agora.ActivityListView)}})}.call(this),function(){var ElectionInfinteView=Agora.GenericListView.extend({el:"#activity-list",templateEl:"#template-search-election-item",renderItem:function(model){var json=model.toJSON();return json.election_at=interpolate(gettext("%(electionname)s at %(agora_full_name)s"),{electionname:json.pretty_name,agora_full_name:json.agora.full_name},!0),this.template(json)}});Agora.ElectionListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new ElectionInfinteView}})}.call(this),function(){var Agora=this.Agora;this.app,function(){var SearchInfiniteView=Agora.GenericListView.extend({el:"#activity-list",templateEl:"#template-search-item",setup:function(){Agora.GenericListView.prototype.setup.apply(this),this.params={q:this.$el.data("query")},this.templates={},ctypes=["agora","election","profile"];for(var i=0;ctypes.length>i;i++){var templateEl="#template-search-"+ctypes[i]+"-item";this.templates[ctypes[i]]=_.template($(templateEl).html())}},renderItem:function(model){this.templateEl;var ctype=model.get("obj").content_type,template=this.templates[ctype],ret=template(model.toJSON().obj);return ret}});Agora.SearchListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new SearchInfiniteView}})}.call(this)}.call(this),function(){var Agora=this.Agora;this.app,Agora.UserView=Backbone.View.extend({el:"div.user",initialize:function(){_.bindAll(this),$("#activity-list").length>0&&(this.activityListView=new Agora.ActivityListView),this.agoralistView=new Agora.AgoraWidgetListView}})}.call(this),function(){var UserInfiniteView=Agora.GenericListView.extend({el:"#user-list",templateEl:"#template-search-profile-item"});Agora.UserListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new UserInfiniteView}})}.call(this);